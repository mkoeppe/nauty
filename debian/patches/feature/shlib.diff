From: David Bremner <bremner@unb.ca>
Subject: [PATCH] feature/shlib

Modify makefile.in to support building a shared library and static
library.


Signed-off-by: David Bremner <bremner@unb.ca>

---
 makefile.in |  197 ++++++++++++++++++++++++++++++-----------------------------
 1 files changed, 101 insertions(+), 96 deletions(-)

diff --git a/makefile.in b/makefile.in
index 90de395..56f3a75 100644
--- a/makefile.in
+++ b/makefile.in
@@ -18,35 +18,68 @@ S1=-DMAXN=WORDSIZE -DWORDSIZE=16
 S=-DWORDSIZE=16
 L=-DWORDSIZE=64
 FOURK=-DMAXN=4096
+PICFLAGS=-fPIC
+
+
+NAUTYLIBOBJ= naututil.o nauty.o nautil.o nautinv.o naugraph.o rng.o
+GTLIBOBJ=gtools.o gtnauty.o nausparse.o gutil1.o gutil2.o naugroup.o
+LIBOBJ=${NAUTYLIBOBJ} ${GTLIBOBJ}
+
+SHNAUTYLIBOBJ= naututil.os nauty.os nautil.os nautinv.os naugraph.os rng.os
+SHGTLIBOBJ=gtools.os gtnauty.os nausparse.os gutil1.os gutil2.os naugroup.os
+SHLIBOBJ=${SHNAUTYLIBOBJ} ${SHGTLIBOBJ}
+
+
+SONAME=libnauty.so.0
+SOMINOR=.0.0
+SHLIB=$(SONAME)$(SOMINOR)
+BUILDSHLIBS=libnauty.so $(SONAME) $(SHLIB)
+BUILDSHLIBS=
+
+LDFLAGS:=-L. -lnauty  $(LDFLAGS)
+
+.SUFFIXES: .os
+.c.os:
+	${CC} -c ${PICFLAGS} ${CFLAGS} -o $@ $<
+
+%.o: %.c
+	${CC} -c ${CFLAGS} -o $@ $<
 
 all : nauty gtools ;
 
 nauty : dreadnaut ;
 
+libs: libnauty.a $(BUILDSHLIBS)
+
 gtools : copyg listg labelg dretog amtog geng complg shortg showg NRswitchg \
   biplabg addedgeg deledgeg countg pickg genrang newedgeg catg genbg directg \
   multig planarg ;
 
+$(SHLIB): $(SHLIBOBJ)
+	gcc -shared -Wl,-soname=$(SONAME) -o $(SONAME)$(SOMINOR) $(SHLIBOBJ)
+
+$(SONAME): $(SHLIB)
+	rm -f $@ && ln -s $(SHLIB) $@
+
+libnauty.so: $(SONAME)
+	rm -f $@ && ln -s $(SONAME) $@
+
+libnauty.a: $(LIBOBJ)
+	ar r $@ $(LIBOBJ)
+
 rng.o: rng.c
 	${CC} -c ${CFLAGS} rng.c
 
-dreadnaut: dreadnaut.c naututil.o nauty.o nautil.o nautinv.o naugraph.o rng.o
-	${CC} -o dreadnaut ${SAFECFLAGS} dreadnaut.c \
-	    naututil.o nauty.o nautil.o nautinv.o naugraph.o rng.o ${LDFLAGS}
+dreadnaut: dreadnaut.c libs
+	${CC} -o dreadnaut ${SAFECFLAGS} dreadnaut.c   ${LDFLAGS}
+
 naututil.o: nauty.h naututil.h naututil.c
-	${CC} -c ${CFLAGS} naututil.c
 nautil.o: nauty.h nautil.c
-	${CC} -c ${CFLAGS} nautil.c
 nauty.o: nauty.h nauty.c
-	${CC} -c ${CFLAGS} nauty.c
 nautinv.o: nauty.h naututil.h nautinv.c
-	${CC} -c ${CFLAGS} nautinv.c
 nautaux.o: nautaux.h nauty.h naututil.h nautaux.c
-	${CC} -c ${CFLAGS} nautaux.c
 naugraph.o: nauty.h naugraph.c
-	${CC} -c ${CFLAGS} naugraph.c
 nausparse.o : nauty.h nausparse.h nausparse.c
-	${CC} -c ${CFLAGS} nausparse.c
 
 dreadnaut1: dreadnaut.c naututil1.o nauty1.o nautil1.o \
             nautinv1.o naugraph1.o rng.o
@@ -173,6 +206,7 @@ clean:
 		dreadtestS${EXEEXT} dreadtestS1${EXEEXT} \
 	        dreadtest4K${EXEEXT} dreadtest1${EXEEXT} \
 		dreadtestL1${EXEEXT} dreadtestW1${EXEEXT}
+	rm -f libnauty.* *.os
 
 gtools.h : nauty.h naututil.h nausparse.h
 	touch gtools.h
@@ -189,111 +223,82 @@ gutil1.o : gtools.h gutils.h gutil1.c
 gutil2.o : gtools.h gutils.h gutil2.c
 	${CC} -c ${CFLAGS} gutil2.c
 
-catg : gtools.h catg.c gtools.o
-	${CC} -o catg ${CFLAGS} catg.c gtools.o ${LDFLAGS}
+catg : gtools.h catg.c libs
+	${CC} -o catg ${CFLAGS} catg.c ${LDFLAGS}
 
-copyg : gtools.h copyg.c gtools.o
-	${CC} -o copyg ${CFLAGS} copyg.c gtools.o ${LDFLAGS}
+copyg : gtools.h copyg.c libs
+	${CC} -o copyg ${CFLAGS} copyg.c ${LDFLAGS}
 
-listg : gtools.h listg.c gtools.o nautil.o
-	${CC} -o listg ${CFLAGS} listg.c gtools.o nautil.o ${LDFLAGS}
+listg : gtools.h listg.c libs
+	${CC} -o listg ${CFLAGS} listg.c  ${LDFLAGS}
 
-labelg : gtools.h naututil.h labelg.c gtools.o gtnauty.o nauty.o \
-            nautil.o naugraph.o nautinv.o nausparse.h nausparse.o \
-	    gutils.h gutil2.o
-	${CC} -o labelg ${SAFECFLAGS} labelg.c gtools.o gtnauty.o \
-	    nauty.o nautil.o naugraph.o nautinv.o nausparse.o \
-	    gutil2.o ${LDFLAGS}
+labelg : gtools.h naututil.h labelg.c libs
+	${CC} -o labelg ${SAFECFLAGS} labelg.c ${LDFLAGS}
 
-shortg : gtools.h shortg.c gtools.o gtnauty.o nauty.o nautil.o naugraph.o \
-            nausparse.h nausparse.o gutils.h gutil2.o nautinv.h nautinv.o
-	${CC} -o shortg ${CFLAGS} shortg.c gtools.o gtnauty.o nautinv.o \
-            nauty.o nautil.o naugraph.o nausparse.o gutil2.o ${LDFLAGS}
+shortg : gtools.h shortg.c libs
+	${CC} -o shortg ${CFLAGS} shortg.c ${LDFLAGS}
 
-dretog : gtools.h dretog.c gtools.o naututil.o nautil.o naugraph.o rng.o
-	${CC} -o dretog ${CFLAGS} dretog.c \
-		gtools.o naututil.o nautil.o rng.o naugraph.o ${LDFLAGS}
+dretog : gtools.h dretog.c libs
+	${CC} -o dretog ${CFLAGS} dretog.c ${LDFLAGS}
 
-amtog : gtools.h amtog.c gtools.o
-	${CC} -o amtog ${CFLAGS} amtog.c gtools.o ${LDFLAGS}
+amtog : gtools.h amtog.c libs
+	${CC} -o amtog ${CFLAGS} amtog.c ${LDFLAGS}
 
-genbg : gtools.h genbg.c gtools.o nauty1.o nautil1.o naugraph1.o
-	${CC} -o genbg ${CFLAGS} ${W1} genbg.c gtools.o \
+genbg : gtools.h genbg.c  nauty1.o nautil1.o naugraph1.o
+	${CC} -o genbg ${CFLAGS} ${W1} genbg.c  \
 		nauty1.o nautil1.o naugraph1.o ${LDFLAGS}
 
 genbgL : gtools.h genbg.c gtoolsL1.o nautyL1.o nautilL1.o naugraphL1.o
 	${CC} -o genbgL ${CFLAGS} ${L1} -DMAXN1=30 genbg.c gtoolsL1.o \
 	    nautyL1.o nautilL1.o naugraphL1.o ${LDFLAGS}
 
-geng : gtools.h geng.c gtools.o nauty1.o nautil1.o naugraph1.o
-	${CC} -o geng ${CFLAGS} -DMAXN=32 geng.c gtools.o nauty1.o \
+geng : gtools.h geng.c  nauty1.o nautil1.o naugraph1.o
+	${CC} -o geng ${CFLAGS} -DMAXN=32 geng.c  nauty1.o \
 		nautil1.o naugraph1.o ${LDFLAGS}
 
-geng16 : gtools.h geng.c gtools.o nauty1.o nautil1.o naugraph1.o
-	${CC} -o geng16 ${CFLAGS} -DMAXN=16 geng.c gtools.o nauty1.o \
+geng16 : gtools.h geng.c  nauty1.o nautil1.o naugraph1.o
+	${CC} -o geng16 ${CFLAGS} -DMAXN=16 geng.c  nauty1.o \
 		nautil1.o naugraph1.o ${LDFLAGS}
 
-geng24 : gtools.h geng.c gtools.o nauty1.o nautil1.o naugraph1.o
-	${CC} -o geng24 ${CFLAGS} -DMAXN=24 geng.c gtools.o nauty1.o \
+geng24 : gtools.h geng.c  nauty1.o nautil1.o naugraph1.o
+	${CC} -o geng24 ${CFLAGS} -DMAXN=24 geng.c  nauty1.o \
 		nautil1.o naugraph1.o ${LDFLAGS}
 
-genrang : gtools.h genrang.c gtools.o naututil.o nautil.o naugraph.o \
-	    rng.o nausparse.o
-	${CC} -o genrang ${CFLAGS} genrang.c nausparse.o \
-		gtools.o nautil.o naututil.o naugraph.o rng.o ${LDFLAGS}
-
-complg : gtools.h complg.c gtools.o gtnauty.o nauty.o nautil.o \
-           naugraph.o nausparse.o
-	${CC} -o complg ${CFLAGS} complg.c gtools.o gtnauty.o \
-               nauty.o nautil.o naugraph.o nausparse.o ${LDFLAGS}
-
-biplabg : gtools.h biplabg.c gtools.o nautil.o naugraph.o gutil1.o
-	${CC} -o biplabg ${CFLAGS} biplabg.c \
-		gtools.o nautil.o naugraph.o gutil1.o ${LDFLAGS}
-
-NRswitchg : gtools.h NRswitchg.c gtools.o gtnauty.o nauty.o nautil.o \
-               nausparse.o naugraph.o
-	${CC} -o NRswitchg ${CFLAGS} NRswitchg.c gtools.o gtnauty.o \
-		 nauty.o nautil.o naugraph.o nausparse.o ${LDFLAGS}
-
-deledgeg : gtools.h deledgeg.c gtools.o gtnauty.o nauty.o nautil.o \
-               naugraph.o nausparse.o
-	${CC} -o deledgeg ${CFLAGS} deledgeg.c gtools.o gtnauty.o \
-		 nauty.o nautil.o naugraph.o nausparse.o ${LDFLAGS}
-
-addedgeg : gtools.h addedgeg.c gtools.o gtnauty.o nauty.o nautil.o \
-               naugraph.o gutil1.o nausparse.o
-	${CC} -o addedgeg ${CFLAGS} addedgeg.c gtools.o gtnauty.o \
-		 nauty.o nautil.o naugraph.o gutil1.o nausparse.o ${LDFLAGS}
-
-newedgeg : gtools.h newedgeg.c nausparse.o \
-             gtools.o gtnauty.o nauty.o nautil.o naugraph.o
-	${CC} -o newedgeg ${CFLAGS} newedgeg.c gtools.o gtnauty.o \
-		 nauty.o nautil.o naugraph.o nausparse.o ${LDFLAGS}
-
-pickg : gtools.h testg.c splay.c nausparse.o \
-	     gtools.o gtnauty.o nauty.o nautil.o naugraph.o gutil1.o gutil2.o
-	${CC} -o pickg ${SAFECFLAGS} testg.c gtools.o gtnauty.o gutil1.o \
-	        gutil2.o nauty.o nautil.o naugraph.o nausparse.o ${LDFLAGS}
-
-countg : gtools.h testg.c splay.c nausparse.o \
-	     gtools.o gtnauty.o nauty.o nautil.o naugraph.o gutil1.o gutil2.o
-	${CC} -o countg ${SAFECFLAGS} testg.c gtools.o gtnauty.o gutil1.o \
-	         gutil2.o nauty.o nautil.o naugraph.o nausparse.o ${LDFLAGS}
-
-directg : gtools.h naugroup.h directg.c \
-             gtools.o nauty.o nautil.o naugraph.o naugroup.o
-	${CC} -o directg ${CFLAGS} directg.c gtools.o \
-                nauty.o nautil.o naugraph.o naugroup.o ${LDFLAGS}
-
-multig : gtools.h naugroup.h multig.c \
-             gtools.o nauty.o nautil.o naugraph.o naugroup.o
-	${CC} -o multig ${CFLAGS} multig.c gtools.o \
-                nauty.o nautil.o naugraph.o naugroup.o ${LDFLAGS}
-
-planarg : gtools.h planarg.c gtools.o planarity.c
-	${CC} -o planarg ${CFLAGS} \
-		planarg.c planarity.c gtools.o ${LDFLAGS}
+genrang : gtools.h genrang.c libs
+	${CC} -o genrang ${CFLAGS} genrang.c ${LDFLAGS}
+
+complg : gtools.h complg.c 
+	${CC} -o complg ${CFLAGS} complg.c ${LDFLAGS}
+
+biplabg : gtools.h biplabg.c libs
+	${CC} -o biplabg ${CFLAGS} biplabg.c  ${LDFLAGS}
+
+NRswitchg : gtools.h NRswitchg.c libs
+	${CC} -o NRswitchg ${CFLAGS} NRswitchg.c ${LDFLAGS}
+
+deledgeg : gtools.h deledgeg.c libs
+	${CC} -o deledgeg ${CFLAGS} deledgeg.c ${LDFLAGS}
+
+addedgeg : gtools.h addedgeg.c libs
+	${CC} -o addedgeg ${CFLAGS} addedgeg.c   ${LDFLAGS}
+
+newedgeg : gtools.h newedgeg.c libs
+	${CC} -o newedgeg ${CFLAGS} newedgeg.c ${LDFLAGS}
+
+pickg : gtools.h testg.c splay.c libs
+	${CC} -o pickg ${SAFECFLAGS} testg.c ${LDFLAGS}
+
+countg : gtools.h testg.c splay.c libs
+	${CC} -o countg ${SAFECFLAGS} testg.c  ${LDFLAGS}
+
+directg : gtools.h naugroup.h directg.c libs
+	${CC} -o directg ${CFLAGS} directg.c  ${LDFLAGS}
+
+multig : gtools.h naugroup.h multig.c libs
+	${CC} -o multig ${CFLAGS} multig.c ${LDFLAGS}
+
+planarg : gtools.h planarg.c  planarity.c libs
+	${CC} -o planarg ${CFLAGS} planarg.c planarity.c  ${LDFLAGS}
 
 showg : showg.c
 	${CC} -o showg ${CFLAGS} showg.c ${LDFLAGS}
-- 
tg: (f17151d..) feature/shlib (depends on: upstream)
